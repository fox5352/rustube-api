name: Rust

on:
  push:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:

  build:
    strategy:
      matrix:
        platform: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
    - name: Check for GitHub Actions Bot
      id: check
      run: |
        if [[ "${{ github.event.head_commit.committer.name }}" == "GitHub Actions" ]]; then
          echo "Skipping workflow run for commit from GitHub Actions bot"
          echo "::set-output name=skip::true"
        else
          echo "::set-output name=skip::false"
        fi

    - name: Build
      if: ${{ steps.check.outputs.skip != 'true' }}
      uses: actions/checkout@v3

    - name: Build
      if: ${{ steps.check.outputs.skip != 'true' }}
      run: cargo build --verbose --release --bin rustube-api

    - name: Create Release Directory
      if: ${{ steps.check.outputs.skip != 'true' }}
      run: mkdir release

    - name: Move Build Output (Ubuntu)
      if: ${{ steps.check.outputs.skip != 'true' && matrix.platform == 'ubuntu-latest' }}
      run: mv target/release/rustube-api release/rustube-api-ubuntu

    - name: Move Build Output (Windows)
      if: ${{ steps.check.outputs.skip != 'true' && matrix.platform == 'windows-latest' }}
      run: mv target/release/rustube-api.exe release/rustube-api-windows.exe

    - name: Upload Artifact
      if: ${{ steps.check.outputs.skip != 'true' }}
      uses: actions/upload-artifact@v3
      with:
        name: release-${{ matrix.platform }}
        path: release

    - name: Configure Git
      if: ${{ steps.check.outputs.skip != 'true' }}
      run: |
        git config --global user.email "christophervos522@gmail.com"
        git config --global user.name "Chris"

    - name: Commit Release Folder
      if: ${{ steps.check.outputs.skip != 'true' }}
      run: |
        git checkout master
        git add release
        git commit -m "GitHub Actions"
        git push origin master
